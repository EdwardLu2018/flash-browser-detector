<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">

    <title>GLITTER tag</title>

    <style type="text/css">
        body {
            display: flex;
            justify-content: center;
            background: #333;
        }
        #tag {
            background: #666;
            width: 85vmin;
            height: 85vmin;
            border: 5vmin;
            border-style: solid;
            border-color: black;
            margin: 10px;
        }
    </style>
</head>
<body>
    <div id="tag"></div>

    <script type="text/javascript">
        const tag = document.getElementById("tag");

        function getUrlVars() {
            const vars = {};
            const parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m, key, value) {
                vars[key] = value;
            });
            return vars;
        }

        function getUrlParam(parameter, defaultValue) {
            let urlParameter = defaultValue;
            if (window.location.href.indexOf(parameter) > -1) {
                urlParameter = getUrlVars()[parameter];
            }
            if (urlParameter === "") {
                return defaultValue;
            }
            return urlParameter;
        }

        function dec2bin(dec) {
            return (dec >>> 0).toString(2);
        }

        function doubleBits(code) {
            let res = 0;
            for (let i = 0; i < 8; i++) {
                console.log(code & (1<<i));
                res |= (!!(code & (1<<i)) << (2*i));
                res |= (!!(code & (1<<i)) << (2*i+1));
            }
            return res;
        }

        const freq = getUrlParam("freq") ? parseInt(getUrlParam("freq")) : 15;
        const period = (1/freq) * 1000;
        let code = getUrlParam("code") ? parseInt(getUrlParam("code")) : 0xa7;
        const len = 8;

        let started = false;
        let blink;
        window.onmouseup = window.ontouchend = function() {
            if (!started) {
                let idx = 0;
                blink = setInterval(function() {
                    // console.log(dec2bin(code & (1 << (len-idx-1))));
                    const bit = !!(code & (1 << (len-idx-1)));
                    if (bit == 1) {
                        tag.style.background = "white"
                        const nextIdx = (idx+1) % len;
                        const nextBit = code & (1 << (len-idx-1));
                        if (nextBit != bit) {
                            setTimeout(() => {
                                tag.style.background = "#666"
                            }, period/2);
                        }
                    }
                    else {
                        tag.style.background = "#666"
                    }
                    idx = (idx+1) % len;
                }, period);
            }
            else {
                clearInterval(blink);
                tag.style.background = "#666"
            }
            started = !started;
        }
    </script>
</body>
</html>
