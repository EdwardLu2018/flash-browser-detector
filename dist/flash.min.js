!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Flash=e():t.Flash=e()}("undefined"!=typeof self?self:this,()=>(()=>{var t={851:t=>{t.exports="#version 300 es\nprecision highp int;\nprecision mediump float;\nprecision mediump sampler2D;\nout vec4 color;\nin vec2 texCoord;\nuniform vec2 texSize;\nuniform sampler2D image;\nuniform float kernel[25];\n#define pixelAtOffset(img, offset) textureLodOffset((img), texCoord, 0.0f, (offset))\n#define S(x,y,k) result += pixelAtOffset(image, ivec2((x),(y))) * kernel[k]\nconst vec4 g = vec4(0.299f, 0.587f, 0.114f, 0.0f);\nvoid main(void) {\nvec4 result = vec4(0.0f);\nS(-2,-2, 24);\nS(-2,-1, 23);\nS(-2, 0, 22);\nS(-2, 1, 21);\nS(-2, 2, 20);\nS(-1,-2, 19);\nS(-1,-1, 18);\nS(-1, 0, 17);\nS(-1, 1, 16);\nS(-1, 2, 15);\nS( 0,-2, 14);\nS( 0,-1, 13);\nS( 0, 0, 12);\nS( 0, 1, 11);\nS( 0, 2, 10);\nS( 1,-2, 9);\nS( 1,-1, 8);\nS( 1, 0, 7);\nS( 1, 1, 6);\nS( 1, 2, 5);\nS( 2,-2, 4);\nS( 2,-1, 3);\nS( 2, 0, 2);\nS( 2, 1, 1);\nS( 2, 2, 0);\nfloat gray = dot(result, g);\ncolor = vec4(gray, gray, gray, 1.0f);\n}"},611:t=>{t.exports="#version 300 es\nprecision highp int;\nprecision mediump float;\nlayout (location=0) in vec2 a_position;\nlayout (location=1) in vec2 a_texCoord;\nout vec2 texCoord;\nvoid main() {\ngl_Position = vec4(a_position, 0.0f, 1.0f);\ntexCoord = a_texCoord;\n}"}},e={};function i(s){var r=e[s];if(void 0!==r)return r.exports;var n=e[s]={exports:{}};return t[s](n,n.exports,i),n.exports}i.m=t,i.d=(t,e)=>{for(var s in e)i.o(e,s)&&!i.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},i.u=t=>t+".flash.min.js",i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),i.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},(()=>{var t;i.g.importScripts&&(t=i.g.location+"");var e=i.g.document;if(!t&&e&&(e.currentScript&&(t=e.currentScript.src),!t)){var s=e.getElementsByTagName("script");s.length&&(t=s[s.length-1].src)}if(!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),i.p=t})(),i.b=document.baseURI||self.location.href;var s={};return(()=>{"use strict";i.r(s),i.d(s,{FlashDetector:()=>r,FlashSource:()=>l,Utils:()=>t});class t{static isMobile(){return/Android|mobile|iPad|iPhone/i.test(navigator.userAgent)}static dec2bin(t){return(t>>>0).toString(2)}static round3(t){return Math.round(1e3*(t+Number.EPSILON))/1e3}}class e{constructor(t,e){this.callback=t,this.interval=e,this.running=!1}run(){const t=this,e=performance.now();function i(e){t.running&&(t.callback(e),s(e))}function s(s){if(Math.abs(1e3/t.interval-60)<=1e-5)return requestAnimationFrame(i),void console.log("here");const r=s-e,n=Math.round(r/t.interval)*t.interval,o=e+n+t.interval-performance.now();setTimeout(()=>requestAnimationFrame(i),o)}t.running=!0,s(e)}stop(){this.running=!1}}class r{constructor(t,e,s,r){this.codes=t,this.targetFps=e,this.fpsInterval=1e3/this.targetFps,this.source=s,this.sourceWidth=this.source.options.width,this.sourceHeight=this.source.options.height,this.imageDecimate=1,this.options={decimateImage:!1,maxImageDecimationFactor:3,imageDecimationDelta:.2,rangeThreshold:20,minWhiteBlackDiff:100,ttlFrames:8,thresDistShape:50,thresDistShapeTTL:20,thresDistCenter:25},this.setOptions(r),this.worker=new Worker(new URL(i.p+i.u(873),i.b))}createTimer(t){return new e(t,this.fpsInterval)}init(){this.worker.postMessage({type:"init",codes:this.codes,width:this.sourceWidth,height:this.sourceHeight,targetFps:this.targetFps,options:this.options});let t=null;return this.worker.onmessage=e=>{const i=e.data;switch(i.type){case"loaded":return void(t&&t());case"result":{const t=new CustomEvent("onFlashTagsFound",{detail:{tags:i.tags}});return void window.dispatchEvent(t)}case"resize":return void this.decimate()}},new Promise((function(e){t=e}))}decimate(){this.imageDecimate+=this.options.imageDecimationDelta,this.imageDecimate=t.round3(this.imageDecimate);var e=this.sourceWidth/this.imageDecimate,i=this.sourceHeight/this.imageDecimate;this.source.postprocessor.resize(e,i),this.worker.postMessage({type:"resize",width:e,height:i,decimate:this.imageDecimate});const s=new CustomEvent("onFlashCalibrate",{detail:{decimationFactor:this.imageDecimate}});window.dispatchEvent(s)}setOptions(t){t&&(this.options=Object.assign(this.options,t))}addCode(t){this.worker.postMessage({type:"add code",code:t})}detectTags(t){this.worker.postMessage({type:"process",imagedata:t})}}const n="undefined"!=typeof queueMicrotask&&queueMicrotask||"undefined"!=typeof process&&process.nextTick||(t=>Promise.resolve().then(t));class o{constructor(t){this._state=0,this._value=void 0,this._onFulfillment=null,this._onRejection=null,this._children=0,this[0]=this,this._parent=void 0,this._flags=0,this._fulfill=this._fulfill.bind(this),this._reject=this._reject.bind(this),this._resolve=this._resolve.bind(this),this._broadcastIfAsync=this._broadcastIfAsync.bind(this),t(this._fulfill,this._reject)}then(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const i=new o(this._nop);return i._onFulfillment="function"==typeof t&&t,i._onRejection="function"==typeof e&&e,i._parent=this,this[this._children++]=i,this._flags&=-2,this._notify(),i}catch(t){return this.then(null,t)}finally(t){const e=e=>(t(),e);return this.then(e,e)}turbocharge(){let t=this;for(this._flags|=1;void 0!==t._parent;)t=t._parent,t._flags|=1;return t._notify(),this}toString(){switch(this._state){case 0:return"FastPromise { <pending> }";case 1:return`FastPromise { <fulfilled> ${this._value} }`;case 2:return`FastPromise { <rejected> ${this._value} }`;default:return""}}static resolve(t){const e=new o(this._snop);return"object"==typeof t&&null!==t&&"then"in t||"function"==typeof t&&"then"in t?e._resolve(t):(e._value=t,e._state=1),e}static reject(t){const e=new o(this._snop);return e._value=t,e._state=2,e}static all(t){return new o((e,i)=>{const s=[];for(const e of t)s.push(e);const r=s.length;if(0==r)return void e([]);let n=r;const h=new Array(r),a=t=>i=>{h[t]=i,0==--n&&e(h)};for(let t=0;t<r;t++){const e=s[t];e.__proto__===o.prototype||e.__proto__===Promise.prototype?e.then(a(t),i):o.resolve(e).then(a(t),i)}})}static race(t){return new o((e,i)=>{const s=[];for(const e of t)s.push(e);const r=s.length;for(let t=0;t<r;t++){const r=s[t];r.__proto__===o.prototype||r.__proto__===Promise.prototype?r.then(e,i):o.resolve(r).then(e,i)}})}_fulfill(t){this._setState(1,t)}_reject(t){this._setState(2,t)}_setState(t,e){0==this._state&&(this._state=t,this._value=e,this._notify())}_notify(){0!=this._state&&(1&this._flags?this._broadcast():n(this._broadcastIfAsync))}_broadcastIfAsync(){1&this._flags||this._broadcast()}_broadcast(){const t=this._children,e=this._state;if(1===e)for(let e=0;e<t;e++){const t=this[e],i=t._onFulfillment;try{i?i!==t._nop&&(t._resolve(i(this._value)),t._onFulfillment=t._nop):t._fulfill(this._value)}catch(e){t._reject(e)}}else if(2===e)for(let e=0;e<t;e++){const t=this[e],i=t._onRejection;try{i?i!==t._nop&&(t._resolve(i(this._value)),t._onRejection=t._nop):t._reject(this._value)}catch(e){t._reject(e)}}}_resolve(t){if("object"!=typeof t&&"function"!=typeof t||null===t)this._fulfill(t);else{if(t===this)throw new TypeError;if(t.__proto__!==o.prototype&&t.__proto__!==Promise.prototype)try{const e=t.then;if("function"==typeof e){let i=this._resolve,s=this._reject;try{e.call(t,t=>{i(t),i=s=this._nop},t=>{s(t),i=s=this._nop})}catch(t){i!==this._nop&&s!==this._nop&&this._reject(t)}}else this._fulfill(t)}catch(t){this._reject(t)}else t.then(this._resolve,this._reject)}}_nop(){}static _snop(){}}const h=navigator.userAgent.includes("Firefox")?function(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),s=1;s<e;s++)i[s-1]=arguments[s];return setTimeout(t,10,...i)}:function(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),s=1;s<e;s++)i[s-1]=arguments[s];return requestAnimationFrame(()=>t.apply(window,i))};class a{static createGL(t){if(!a.supportsWebGL2(t))throw alert("FLASH requires WebGL 2.0!"),new Error("FLASH requires WebGL 2.0!");const e=t.getContext("webgl2",{premultipliedAlpha:!1,preserveDrawingBuffer:!1,alpha:!0,antialias:!1,depth:!1,stencil:!1});e.clearColor(.1,.1,.1,1),e.clear(e.COLOR_BUFFER_BIT);const i=e.createBuffer(),s=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,i),e.bufferData(e.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),e.STATIC_DRAW),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,s),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),e.STATIC_DRAW),e.enableVertexAttribArray(1),e.vertexAttribPointer(1,2,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,null),e.bindVertexArray(null),e}static supportsWebGL2(t){return!!t.getContext("webgl2")}static resize(t){t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight)}static createShader(t,e,i){const s=t.createShader(e);return t.shaderSource(s,i),t.compileShader(s),t.getShaderParameter(s,t.COMPILE_STATUS)?s:(alert(t.getShaderInfoLog(s)),null)}static createProgram(t,e,i){const s=a.createShader(t,t.VERTEX_SHADER,e),r=a.createShader(t,t.FRAGMENT_SHADER,i),n=t.createProgram();return t.attachShader(n,s),t.attachShader(n,r),t.linkProgram(n),n}static useProgram(t,e){t.useProgram(e)}static createBuffer(t){return t.createBuffer()}static createTexture(t,e,i){const s=t.createTexture();return t.bindTexture(t.TEXTURE_2D,s),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA8,e,i,0,t.RGBA,t.UNSIGNED_BYTE,null),t.bindTexture(t.TEXTURE_2D,null),s}static destroyTexture(t,e){t.deleteTexture(e)}static bindTexture(t,e){return t.bindTexture(t.TEXTURE_2D,e),e}static bindElem(t,e){t.texImage2D(t.TEXTURE_2D,0,t.RGBA8,t.RGBA,t.UNSIGNED_BYTE,e)}static updateElem(t,e){t.texSubImage2D(t.TEXTURE_2D,0,0,0,t.RGBA,t.UNSIGNED_BYTE,e)}static createFramebuffer(t,e){const i=t.createFramebuffer();return t.bindFramebuffer(t.FRAMEBUFFER,i),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,e,0),t.bindFramebuffer(t.FRAMEBUFFER,null),i}static checkFramebufferStatus(t){return t.checkFramebufferStatus(t.FRAMEBUFFER)==t.FRAMEBUFFER_COMPLETE}static destroyFramebuffer(t,e){t.deleteFramebuffer(e)}static draw(t,e,i){t.viewport(0,0,e,i),t.drawArrays(t.TRIANGLES,0,6)}static readPixels(t,e,i,s){t.readPixels(0,0,e,i,t.RGBA,t.UNSIGNED_BYTE,s)}static readPixelsAsync(t,e,i,s,r){t.bindBuffer(t.PIXEL_PACK_BUFFER,e),t.bufferData(t.PIXEL_PACK_BUFFER,r.byteLength,t.DYNAMIC_READ),t.readPixels(0,0,i,s,t.RGBA,t.UNSIGNED_BYTE,0),t.bindBuffer(t.PIXEL_PACK_BUFFER,null);const n=t.fenceSync(t.SYNC_GPU_COMMANDS_COMPLETE,0);return t.flush(),new o((e,i)=>{h(a.clientWaitAsync,t,n,0,e,i)}).then(()=>{t.bindBuffer(t.PIXEL_PACK_BUFFER,e),t.getBufferSubData(t.PIXEL_PACK_BUFFER,0,r),t.bindBuffer(t.PIXEL_PACK_BUFFER,null)}).catch(t=>{throw new Error("error in clientWaitAsync()",t)}).finally(()=>{t.deleteSync(n)})}static clientWaitAsync(t,e,i,s,r){let n=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1e3;!function o(){const h=t.clientWaitSync(e,i,0);n--<=0?r(new Error("_checkStatus() is taking too long.",t.getError())):h===t.CONDITION_SATISFIED||h===t.ALREADY_SIGNALED?s():requestAnimationFrame(o)}()}}class c{constructor(t,e,s){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2;this.width=t,this.height=e,this.canvas=s||document.createElement("canvas"),this.canvas.width=this.width,this.canvas.height=this.height,this.kernel=[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0],this._gl=a.createGL(this.canvas);const n=i(611),o=i(851),h=a.createProgram(this._gl,n,o);a.useProgram(this._gl,h),this._texSizeLocation=this._gl.getUniformLocation(h,"texSize"),this._gl.uniform2f(this._texSizeLocation,this.width,this.height),this._kernelLocation=this._gl.getUniformLocation(h,"kernel[0]"),this._texture=a.createTexture(this._gl,this.width,this.height),a.bindTexture(this._gl,this._texture),this._pixelBuffer=new Array(r).fill(null).map(()=>new Uint8Array(this.width*this.height*4)),this._consumerQueue=new Array(r).fill(0).map((t,e)=>e),this._producerQueue=[],this._pbo=null}async getPixels(){if(!this._source)return null;a.bindElem(this._gl,this._source),a.draw(this._gl,this.width,this.height);const t=this._gl.isBuffer(this._pbo)?this._pbo:this._pbo=a.createBuffer(this._gl);if(this._producerQueue.length>0){const e=this._producerQueue.shift();a.readPixelsAsync(this._gl,t,this.width,this.height,this._pixelBuffer[e]).then(()=>{this._consumerQueue.push(e)})}else this._waitForQueueNotEmpty(this._producerQueue).then(()=>{const e=this._producerQueue.shift();a.readPixelsAsync(this._gl,t,this.width,this.height,this._pixelBuffer[e]).then(()=>{this._consumerQueue.push(e)})}).turbocharge();if(this._consumerQueue.length>0){const t=this._consumerQueue.shift();return new o(e=>{e(this._pixelBuffer[t]),this._producerQueue.push(t)})}return new o(t=>{this._waitForQueueNotEmpty(this._consumerQueue).then(()=>{const e=this._consumerQueue.shift();t(this._pixelBuffer[e]),this._producerQueue.push(e)})}).turbocharge()}_waitForQueueNotEmpty(t){return new o(e=>{!function i(){t.length>0?e():setTimeout(i,0)}()})}setKernelSigma(t){if(0!=t){for(var e=0,i=-2;i<=2;i++)for(var s=-2;s<=2;s++){var r=Math.exp(-(i*i+s*s)/(2*t*t));this.kernel[e]=r,e++}var n=this.kernel.reduce((t,e)=>t+e,0);this.kernel=this.kernel.map((function(t){return t/n}))}else this.kernel=[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0];this._gl.uniform1fv(this._kernelLocation,this.kernel)}resize(t,e){this.width=t,this.height=e,this.canvas.width=this.width,this.canvas.height=this.height,a.resize(this._gl),this._gl.uniform2f(this._textureSizeLocation,this.width,this.height);for(let t=0;t<this._pixelBuffer.length;t++){const e=new Uint8Array(this.width*this.height*4);this._pixelBuffer[t]=e}}attachElem(t){this._source=t,a.bindElem(this._gl,this._source)}}class l{constructor(t){this.options={width:640,height:480,quadSigma:1},this.setOptions(t),this.video=document.createElement("video"),this.video.setAttribute("autoplay",""),this.video.setAttribute("muted",""),this.video.setAttribute("playsinline",""),this.video.style.width=this.options.width+"px",this.video.style.height=this.options.height+"px",this.video.style.position="absolute",this.video.style.top="0px",this.video.style.left="0px",this.video.style.zIndex="0",this.postprocessor=new c(this.options.width,this.options.height),this.postprocessor.setKernelSigma(this.options.quadSigma)}setOptions(t){t&&(this.options=Object.assign(this.options,t),this.postprocessor.resize(this.options.width,this.options.height),this.postprocessor.setKernelSigma(this.options.quadSigma))}resize(t,e){var i=t,s=e,r=this.video.videoWidth/this.video.videoHeight;if(i/s<r){var n=r*s;this.video.style.width=n+"px",this.video.style.marginLeft=-(n-i)/2+"px",this.video.style.height=s+"px",this.video.style.marginTop="0px"}else{var o=1/(r/i);this.video.style.height=o+"px",this.video.style.marginTop=-(o-s)/2+"px",this.video.style.width=i+"px",this.video.style.marginLeft="0px"}}copyDimensionsTo(t){t.style.width=this.video.style.width,t.style.height=this.video.style.height,t.style.marginLeft=this.video.style.marginLeft,t.style.marginTop=this.video.style.marginTop}init(){return new Promise((t,e)=>{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return e();navigator.mediaDevices.getUserMedia({audio:!1,video:{facingMode:"environment",width:{ideal:this.options.width},height:{ideal:this.options.height}}}).then(e=>{this.video.srcObject=e,this.video.onloadedmetadata=e=>{this.video.play(),this.postprocessor.attachElem(this.video),t(this.video)}}).catch(t=>{e(t)})})}getPixels(){return this.postprocessor.getPixels()}}})(),s})());