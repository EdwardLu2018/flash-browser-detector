!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.Glitter=t():e.Glitter=t()}("undefined"!=typeof self?self:this,(function(){return function(e){var t={};function r(i){if(t[i])return t[i].exports;var o=t[i]={i:i,l:!1,exports:{}};return e[i].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,i){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(i,o,function(t){return e[t]}.bind(null,o));return i},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=2)}([function(e,t){e.exports="attribute vec2 position;\nvarying vec2 tex_coords;\nuniform float flipY;\nvoid main(void) {\ntex_coords = (position + 1.0) / 2.0;\ntex_coords.y = 1.0 - tex_coords.y;\ngl_Position = vec4(position * vec2(1, flipY), 0.0, 1.0);\n}"},function(e,t){e.exports="precision highp float;\nuniform sampler2D u_image;\nvarying vec2 tex_coords;\nconst vec3 g = vec3(0.299, 0.587, 0.114);\nvoid main(void) {\nvec4 color = texture2D(u_image, tex_coords);\nfloat gray = dot(color.rgb, g);\ngl_FragColor = vec4(vec3(gray), 1.0);\n}"},function(e,t,r){"use strict";r.r(t),r.d(t,"GrayScaleMedia",(function(){return o})),r.d(t,"GlitterDetector",(function(){return s}));class i{static createGL(e,t,r){const i=e.getContext("webgl");i.viewport(0,0,t,r),i.clearColor(.1,.1,.1,1),i.clear(i.COLOR_BUFFER_BIT);const o=new Float32Array([-1,-1,-1,1,1,1,-1,-1,1,1,1,-1]),s=i.createBuffer();return i.bindBuffer(i.ARRAY_BUFFER,s),i.bufferData(i.ARRAY_BUFFER,o,i.STATIC_DRAW),i}static createShader(e,t,r){const i=e.createShader(t);return e.shaderSource(i,r),e.compileShader(i),i}static createProgram(e,t,r){const o=i.createShader(e,e.VERTEX_SHADER,t),s=i.createShader(e,e.FRAGMENT_SHADER,r),a=e.createProgram();return e.attachShader(a,o),e.attachShader(a,s),e.linkProgram(a),a}static useProgram(e,t){e.useProgram(t)}static createTexture(e,t,r){const i=e.createTexture();return e.bindTexture(e.TEXTURE_2D,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,r,0,e.RGBA,e.UNSIGNED_BYTE,null),e.bindTexture(e.TEXTURE_2D,null),i}static bindTexture(e,t){return e.bindTexture(e.TEXTURE_2D,t),t}static bindElem(e,t){e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t)}static updateElem(e,t){e.texSubImage2D(e.TEXTURE_2D,0,0,0,e.RGBA,e.UNSIGNED_BYTE,t)}static destroyTexture(e,t){e.deleteTexture(t)}static createFramebuffer(e,t){const r=e.createFramebuffer();return e.bindFramebuffer(e.FRAMEBUFFER,r),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0),r}static destroyFramebuffer(e,t){e.deleteFramebuffer(t)}static draw(e){e.drawArrays(e.TRIANGLES,0,6)}static readPixels(e,t,r,i){e.readPixels(0,0,t,r,e.RGBA,e.UNSIGNED_BYTE,i)}}class o{constructor(e,t,o,s){this.source=e,this.width=t,this.height=o,this.canvas=s||document.createElement("canvas"),this.canvas.width=t,this.canvas.height=o,this.gl=i.createGL(this.canvas,this.width,this.height);const a=r(0),n=r(1),u=i.createProgram(this.gl,a,n);i.useProgram(this.gl,u);const c=this.gl.getAttribLocation(u,"position");this.gl.vertexAttribPointer(c,2,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(c);const l=this.gl.getUniformLocation(u,"flipY");this.gl.uniform1f(l,-1),this.texture=i.createTexture(this.gl,this.width,this.height),i.bindTexture(this.gl,this.texture),this.glReady=!0,this.pixelBuf=new Uint8ClampedArray(this.width*this.height*4),this.grayBuf=new Uint8ClampedArray(this.width*this.height)}getPixels(){if(!this.glReady)return;i.updateElem(this.gl,this.source),i.draw(this.gl),i.readPixels(this.gl,this.width,this.height,this.pixelBuf);let e=0;for(let t=0;t<this.pixelBuf.length;t+=4)this.grayBuf[e]=this.pixelBuf[t],e++;return this.grayBuf}requestStream(){return new Promise((e,t)=>{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return t();var r=this.width/this.height;(class{static isMobile(){return/Android|mobile|iPad|iPhone/i.test(navigator.userAgent)}}).isMobile()&&(r=1/r),navigator.mediaDevices.getUserMedia({audio:!1,video:{width:{ideal:this.width},height:{ideal:this.height},aspectRatio:{ideal:r},facingMode:"environment"}}).then(t=>{this.source.srcObject=t,this.source.onloadedmetadata=t=>{this.source.play(),i.bindElem(this.gl,this.source),e(this.source)}}).catch(e=>{t(e)})})}}class s{constructor(e,t){let r=this;this.ready=!1,this.shouldTrack=!1,this.validPoints=!1,this.code=e,GlitterWASM().then((function(e){console.log("GLITTER WASM module loaded."),r.onWasmInit(e),t&&t()}))}onWasmInit(e){this._Module=e,this._init=e.cwrap("init","number",["number"]),this._track=this._Module.cwrap("track","number",["number","number","number"]),this.ready=0==this._init(this.code)}track(e,t,r){let i=[];if(!this.ready)return i;const o=this._Module._malloc(e.length);this._Module.HEAPU8.set(e,o);const s=this._track(o,t,r),a=s/Float64Array.BYTES_PER_ELEMENT,n=this._Module.getValue(s,"double");for(var u=0;u<n;u++){var c={p00:this._Module.HEAPF64[a+10*u+1+0],p01:this._Module.HEAPF64[a+10*u+1+1],p10:this._Module.HEAPF64[a+10*u+1+2],p11:this._Module.HEAPF64[a+10*u+1+3],p20:this._Module.HEAPF64[a+10*u+1+4],p21:this._Module.HEAPF64[a+10*u+1+5],p30:this._Module.HEAPF64[a+10*u+1+6],p31:this._Module.HEAPF64[a+10*u+1+7],c0:this._Module.HEAPF64[a+10*u+1+8],c1:this._Module.HEAPF64[a+10*u+1+9]};i.push(c)}return this._Module._free(s),this._Module._free(o),i}}}])}));